'use client';

import { MetricCard } from './MetricCard';
import { useAppSelector } from '@/store/hooks';
import { selectCurrentVitals, selectRealtimeHistory } from '@/features/health/healthSlice';
import type { VitalStatus } from '@/features/health/healthTypes';
import { SkeletonCard } from '@/components/ui/Skeleton';

function classifyHR(v: number): VitalStatus {
    if (v < 50 || v > 120) return 'critical';
    if (v < 60 || v > 100) return 'warning';
    return 'normal';
}

function classifyHRV(v: number): VitalStatus {
    if (v < 10 || v > 100) return 'critical';
    if (v < 20 || v > 80) return 'warning';
    return 'normal';
}

function classifySpO2(v: number): VitalStatus {
    if (v < 90) return 'critical';
    if (v < 95) return 'warning';
    return 'normal';
}

function getTrend(current: number, history: number[]): { trend: 'up' | 'down' | 'stable'; trendValue: number } {
    if (history.length < 2) return { trend: 'stable', trendValue: 0 };
    const prev = history[history.length - 2];
    const diff = current - prev;
    if (Math.abs(diff) < 0.5) return { trend: 'stable', trendValue: 0 };
    return { trend: diff > 0 ? 'up' : 'down', trendValue: diff };
}

const HeartIcon = (
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" className="text-[var(--color-chart-4)]">
        <path
            d="M10 17C10 17 2 12 2 7C2 4.5 4 2.5 6.5 2.5C8 2.5 9.5 3.5 10 5C10.5 3.5 12 2.5 13.5 2.5C16 2.5 18 4.5 18 7C18 12 10 17 10 17Z"
            fill="currentColor" opacity="0.85"
        />
    </svg>
);

const ChartIcon = (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 21 21" className="text-[var(--color-chart-1)]">
        <path d="m0 6.5h2l2.5-6 2 12 3-9 2.095 6 1.405-3h2" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" transform="translate(3 4)" />
    </svg>
);

const LungsIcon = (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48" fill="currentColor" className="text-[var(--color-chart-2)]">
        <path fillRule="evenodd" clipRule="evenodd" d="M18.3616 14.4281C17.9857 14.0417 17.4485 13.7416 16.4944 13.7424C16.1761 13.7426 15.718 13.877 15.0999 14.3973C14.4755 14.9229 13.8025 15.7511 13.1201 16.8837C11.7568 19.1464 10.5551 22.2871 9.65261 25.6089C8.75354 28.9179 8.18539 32.2799 8.0308 34.9299C7.9531 36.2619 7.98437 37.343 8.10186 38.1178C8.16054 38.5048 8.23255 38.7589 8.29188 38.9068C8.29797 38.922 8.30354 38.9351 8.30852 38.9463C9.26857 39.6754 10.907 39.9662 12.9417 39.5699C14.9997 39.169 17.0171 38.1377 18.2942 36.862C18.7374 36.4192 19.1338 35.6888 19.4295 34.5998C19.7217 33.5235 19.8777 32.2384 19.9432 30.8381C20.0084 29.4452 19.9818 28.0055 19.9359 26.6304C19.9233 26.2532 19.909 25.8747 19.8948 25.502C19.8589 24.5552 19.8244 23.6453 19.8237 22.8853C19.8235 22.6274 19.8258 22.3542 19.8282 22.0692C19.8421 20.4219 19.8594 18.3795 19.413 16.6049C19.158 15.5912 18.7954 14.8739 18.3616 14.4281ZM8.33561 39.0002C8.33559 39.0003 8.33466 38.9989 8.33292 38.9958C8.33477 38.9986 8.33564 39.0001 8.33561 39.0002ZM21.8287 22.1383C21.8636 18.6096 21.9316 11.7379 16.4927 11.7424C9.04214 11.7485 3.74153 37.7593 6.93685 40.4104C10.1322 43.0615 16.5171 41.464 19.7076 38.2769C22.2835 35.7039 22.0555 29.6964 21.8919 25.3839C21.8566 24.4547 21.8243 23.6041 21.8237 22.8836C21.8236 22.6577 21.826 22.4077 21.8287 22.1383Z" />
        <path fillRule="evenodd" clipRule="evenodd" d="M29.5788 14.4186C29.9541 14.0316 30.4908 13.7306 31.4449 13.7298C31.7632 13.7295 32.2215 13.8632 32.8404 14.3824C33.4657 14.907 34.14 15.7341 34.8243 16.8656C36.1913 19.1261 37.3982 22.2649 38.3061 25.5851C39.2106 28.8926 39.7843 32.2537 39.9432 34.9035C40.0231 36.2353 39.9936 37.3164 39.8774 38.0915C39.8193 38.4786 39.7477 38.7328 39.6886 38.8808C39.6826 38.896 39.677 38.9091 39.6721 38.9203C38.7132 39.651 37.0753 39.9444 35.0399 39.5515C32.9812 39.154 30.9622 38.1259 29.683 36.8523C29.2391 36.4103 28.8414 35.6805 28.544 34.5921C28.25 33.5162 28.0919 32.2314 28.0241 30.8311C27.9566 29.4384 27.9809 27.9986 28.0245 26.6235C28.0365 26.2462 28.0502 25.8678 28.0638 25.495C28.0981 24.5482 28.1312 23.6382 28.1305 22.8782C28.1303 22.6203 28.1276 22.3471 28.1247 22.0621C28.1081 20.4148 28.0875 18.3724 28.531 16.5971C28.7843 15.583 29.1458 14.8651 29.5788 14.4186ZM39.6451 38.9743C39.6451 38.9743 39.646 38.9729 39.6477 38.9699C39.6459 38.9727 39.645 38.9742 39.6451 38.9743ZM26.1244 22.1345C26.0837 18.6059 26.0044 11.7343 31.4433 11.7298C38.8939 11.7237 44.2371 37.7258 41.0461 40.3821C37.8552 43.0385 31.4676 41.4515 28.2719 38.2696C25.6918 35.7008 25.9099 29.6929 26.0665 25.3802C26.1002 24.4509 26.1311 23.6003 26.1305 22.8798C26.1304 22.6539 26.1275 22.4039 26.1244 22.1345Z" />
        <path fillRule="evenodd" clipRule="evenodd" d="M22.9631 5.73725C22.9631 5.73717 22.9631 5.73712 23.9631 5.7363C24.9631 5.73549 24.9631 5.73553 24.9631 5.73561L24.975 20.2355C24.9767 22.3377 24.0417 23.5441 22.9821 24.1634C22.4849 24.454 21.9964 24.5952 21.6382 24.6651C21.4572 24.7005 21.3036 24.7188 21.1906 24.7283C21.1339 24.7331 21.0869 24.7357 21.0512 24.7371C21.0333 24.7378 21.0182 24.7382 21.0061 24.7384L20.9901 24.7387L20.9838 24.7387L20.9811 24.7388L20.9798 24.7388C20.9792 24.7388 20.9786 24.7388 20.9778 23.7388C20.977 22.7388 20.9765 22.7388 20.9759 22.7388L20.9749 22.7388L20.973 22.7388L20.9699 22.7388L20.9668 22.7388C20.9668 22.7388 20.9684 22.7388 20.9718 22.7387C20.9801 22.7383 20.9975 22.7375 21.0229 22.7353C21.0739 22.731 21.1547 22.7218 21.2549 22.7022C21.4591 22.6623 21.7204 22.5842 21.9729 22.4367C22.4125 22.1797 22.9761 21.6349 22.975 20.2371L22.9631 5.73725Z" />
        <path fillRule="evenodd" clipRule="evenodd" d="M24.9632 5.73566C24.9632 5.73558 24.9632 5.73553 23.9632 5.73635C22.9632 5.73717 22.9632 5.73721 22.9632 5.7373L22.9751 20.2372C22.9768 22.3394 23.9137 23.5443 24.9744 24.1618C25.4721 24.4516 25.9607 24.592 26.3191 24.6614C26.5001 24.6964 26.6538 24.7144 26.7668 24.7238C26.8235 24.7284 26.8705 24.731 26.9062 24.7323C26.9241 24.733 26.9392 24.7334 26.9513 24.7336L26.9673 24.7338L26.9736 24.7339L26.9763 24.7339L26.9776 24.7339C26.9782 24.7339 26.9787 24.7339 26.9779 23.7339C26.9771 22.7339 26.9777 22.7339 26.9782 22.7339L26.9793 22.7339L26.9812 22.7339L26.9842 22.7339L26.9873 22.734C26.9873 22.734 26.9857 22.7339 26.9823 22.7338C26.9741 22.7335 26.9566 22.7326 26.9312 22.7305C26.8802 22.7263 26.7994 22.7172 26.6992 22.6978C26.4949 22.6583 26.2334 22.5806 25.9807 22.4334C25.5407 22.1772 24.9762 21.6333 24.9751 20.2355L24.9632 5.73566Z" />
    </svg>
);

const StepsIcon = (
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" className="text-[var(--color-chart-5)]">
        <circle cx="11.5" cy="4.5" r="2.5" stroke="currentColor" strokeWidth="1.5" />
        <path d="M10.3413 11.5869L11.0876 11.6615V11.6615L10.3413 11.5869ZM11.1906 18.3031C11.411 18.6538 11.874 18.7594 12.2247 18.539C12.5754 18.3185 12.6809 17.8555 12.4605 17.5048L11.1906 18.3031ZM13.7654 22.3992C13.9859 22.7498 14.4489 22.8554 14.7995 22.635C15.1502 22.4145 15.2558 21.9515 15.0354 21.6008L13.7654 22.3992ZM6.30394 13.1323L7.03608 13.295L6.30394 13.1323ZM5.26786 14.3373C5.178 14.7417 5.43295 15.1423 5.8373 15.2321C6.24165 15.322 6.64228 15.067 6.73214 14.6627L5.26786 14.3373ZM17.2702 13.2433L17.033 12.5318V12.5318L17.2702 13.2433ZM18.2372 13.7115C18.6301 13.5805 18.8425 13.1558 18.7115 12.7628C18.5805 12.3699 18.1558 12.1575 17.7628 12.2885L18.2372 13.7115ZM12.5815 10.0051L12.5278 10.7532H12.5278L12.5815 10.0051ZM14.4196 11.6785L13.692 11.8604L13.692 11.8604L14.4196 11.6785ZM14.3391 11.3774L13.6263 11.6109L13.6263 11.6109L14.3391 11.3774ZM7.35289 10.4399L7.82218 11.0249L7.82218 11.0249L7.35289 10.4399ZM14.5269 12.0752L15.2355 11.8294L15.2355 11.8293L14.5269 12.0752ZM16.8779 13.3657L16.7049 12.6359L16.7049 12.6359L16.8779 13.3657ZM14.0924 20.1008C13.872 19.7502 13.409 19.6446 13.0583 19.865C12.7076 20.0855 12.602 20.5485 12.8225 20.8992L14.0924 20.1008ZM9.75372 9.92537L9.59503 11.5123L11.0876 11.6615L11.2463 10.0746L9.75372 9.92537ZM10.5 9.25H10.2087V10.75H10.5V9.25ZM5.5718 12.9696L5.26786 14.3373L6.73214 14.6627L7.03608 13.295L5.5718 12.9696ZM10.5 10.75H12.2698V9.25H10.5V10.75ZM17.5073 13.9548L18.2372 13.7115L17.7628 12.2885L17.033 12.5318L17.5073 13.9548ZM12.2698 10.75C12.442 10.75 12.4897 10.7505 12.5278 10.7532L12.6351 9.25704C12.5304 9.24953 12.4179 9.25 12.2698 9.25V10.75ZM15.1472 11.4966C15.1113 11.3529 15.0845 11.2437 15.0518 11.1439L13.6263 11.6109C13.6382 11.6472 13.6503 11.6934 13.692 11.8604L15.1472 11.4966ZM12.5278 10.7532C13.0342 10.7895 13.4683 11.1284 13.6263 11.6109L15.0518 11.1439C14.7041 10.0826 13.7491 9.33691 12.6351 9.25704L12.5278 10.7532ZM10.2087 9.25C9.45815 9.25 8.82796 9.24871 8.31924 9.31045C7.79022 9.37465 7.30738 9.51494 6.88359 9.85489L7.82218 11.0249C7.9468 10.925 8.12273 10.8453 8.49995 10.7995C8.89746 10.7513 9.42096 10.75 10.2087 10.75V9.25ZM7.03608 13.295C7.20696 12.526 7.32178 12.0153 7.4551 11.6377C7.58162 11.2794 7.69756 11.1249 7.82218 11.0249L6.88359 9.85488C6.45981 10.1948 6.21812 10.6357 6.04069 11.1382C5.87007 11.6215 5.73461 12.2369 5.5718 12.9696L7.03608 13.295ZM13.692 11.8604C13.7401 12.0527 13.7755 12.1973 13.8184 12.321L15.2355 11.8293C15.2201 11.7848 15.2034 11.7211 15.1472 11.4966L13.692 11.8604ZM17.033 12.5318C16.8135 12.6049 16.7507 12.6251 16.7049 12.6359L17.0509 14.0955C17.1783 14.0653 17.3193 14.0175 17.5073 13.9548L17.033 12.5318ZM13.8184 12.321C14.2809 13.6543 15.6777 14.4211 17.0509 14.0955L16.7049 12.6359C16.0807 12.7839 15.4458 12.4354 15.2355 11.8294L13.8184 12.321ZM9.59503 11.5123C9.43093 13.1533 9.32238 14.1447 9.54827 15.1061L11.0085 14.763C10.853 14.1013 10.9135 13.4019 11.0876 11.6615L9.59503 11.5123ZM12.4605 17.5048C11.5296 16.024 11.164 15.4248 11.0085 14.763L9.54827 15.1061C9.77416 16.0676 10.3128 16.9069 11.1906 18.3031L12.4605 17.5048ZM12.8225 20.8992L13.7654 22.3992L15.0354 21.6008L14.0924 20.1008L12.8225 20.8992Z" fill="currentColor" />
        <path d="M9 17.5L6 22" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
    </svg>
);

export function MetricGrid() {
    const vitals = useAppSelector(selectCurrentVitals);
    const history = useAppSelector(selectRealtimeHistory);

    // Show skeleton while waiting for data
    if (!vitals) {
        return (
            <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                {Array.from({ length: 4 }).map((_, i) => (
                    <SkeletonCard key={i} />
                ))}
            </div>
        );
    }

    // Extract sparkline data(last 10 readings for each metric)
    const hrHistory = history.slice(-10).map((v) => v.heartRate);
    const hrvHistory = history.slice(-10).map((v) => v.hrv);
    const spo2History = history.slice(-10).map((v) => v.spO2);
    const stepsHistory = history.slice(-10).map((v) => v.steps);

    const hrTrend = getTrend(vitals.heartRate, hrHistory);
    const hrvTrend = getTrend(vitals.hrv, hrvHistory);
    const spo2Trend = getTrend(vitals.spO2, spo2History);
    const stepsTrend = getTrend(vitals.steps, stepsHistory);

    const cards = [
        {
            label: 'Heart Rate',
            value: vitals.heartRate,
            unit: 'bpm',
            icon: HeartIcon,
            ...hrTrend,
            status: classifyHR(vitals.heartRate),
            sparklineData: hrHistory,
            sparklineColor: 'var(--color-chart-4)',
        },
        {
            label: 'HRV',
            value: vitals.hrv,
            unit: 'ms',
            icon: ChartIcon,
            ...hrvTrend,
            status: classifyHRV(vitals.hrv),
            sparklineData: hrvHistory,
            sparklineColor: 'var(--color-chart-1)',
        },
        {
            label: 'SpO₂',
            value: vitals.spO2,
            unit: '%',
            icon: LungsIcon,
            ...spo2Trend,
            status: classifySpO2(vitals.spO2),
            sparklineData: spo2History,
            sparklineColor: 'var(--color-chart-2)',
        },
        {
            label: 'Steps',
            value: vitals.steps,
            unit: 'steps',
            icon: StepsIcon,
            ...stepsTrend,
            status: 'normal' as VitalStatus,
            sparklineData: stepsHistory,
            sparklineColor: 'var(--color-chart-5)',
            formatter: (v: number) => Math.round(v).toLocaleString(),
        },
    ];

    return (
        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
            {cards.map((card) => (
                <MetricCard key={card.label} {...card} />
            ))}
        </div>
    );
}
